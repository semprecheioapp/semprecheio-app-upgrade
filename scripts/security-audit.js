#!/usr/bin/env node

/**
 * Auditoria de Seguran√ßa - SempreCheioApp
 * 
 * Script para avaliar a seguran√ßa do sistema antes da revenda comercial
 */

import fs from 'fs';
import path from 'path';

const AUDIT_DATE = new Date().toISOString().split('T')[0];
const AUDIT_REPORT = `security-audit-${AUDIT_DATE}.json`;

class SecurityAuditor {
  constructor() {
    this.findings = {
      critical: [],
      high: [],
      medium: [],
      low: [],
      passed: []
    };
    
    this.categories = {
      authentication: 'Autentica√ß√£o e Autoriza√ß√£o',
      dataProtection: 'Prote√ß√£o de Dados',
      apiSecurity: 'Seguran√ßa da API',
      infrastructure: 'Infraestrutura',
      codeQuality: 'Qualidade do C√≥digo',
      privacy: 'Privacidade e LGPD'
    };
  }

  addFinding(severity, category, title, description, recommendation, status = 'fail') {
    const finding = {
      severity,
      category: this.categories[category] || category,
      title,
      description,
      recommendation,
      status,
      timestamp: new Date().toISOString()
    };

    if (status === 'pass') {
      this.findings.passed.push(finding);
    } else {
      this.findings[severity].push(finding);
    }
  }

  auditAuthentication() {
    console.log('üîê Auditando Autentica√ß√£o...');

    // Verificar se bcrypt est√° sendo usado
    const storageFile = fs.readFileSync('../server/storage-clients-auth.ts', 'utf8');
    
    if (storageFile.includes('bcrypt.compare') && storageFile.includes('bcrypt.hash')) {
      this.addFinding('low', 'authentication', 
        'Hash de Senha Seguro', 
        'Sistema utiliza bcrypt para hash de senhas',
        'Manter bcrypt atualizado',
        'pass'
      );
    } else {
      this.addFinding('critical', 'authentication',
        'Hash de Senha Inseguro',
        'Senhas n√£o est√£o sendo adequadamente hasheadas',
        'Implementar bcrypt para todas as senhas'
      );
    }

    // Verificar middleware de autentica√ß√£o
    const routesFile = fs.readFileSync('../server/routes.ts', 'utf8');
    
    if (routesFile.includes('requireAuth') && routesFile.includes('sessionId')) {
      this.addFinding('low', 'authentication',
        'Middleware de Autentica√ß√£o',
        'Middleware de autentica√ß√£o implementado corretamente',
        'Considerar implementar JWT para melhor escalabilidade',
        'pass'
      );
    } else {
      this.addFinding('high', 'authentication',
        'Middleware de Autentica√ß√£o Ausente',
        'Rotas n√£o est√£o adequadamente protegidas',
        'Implementar middleware de autentica√ß√£o para todas as rotas protegidas'
      );
    }

    // Verificar gest√£o de sess√µes
    if (storageFile.includes('sessions') && storageFile.includes('expiresAt')) {
      this.addFinding('low', 'authentication',
        'Gest√£o de Sess√µes',
        'Sistema implementa expira√ß√£o de sess√µes',
        'Considerar implementar renova√ß√£o autom√°tica de sess√µes',
        'pass'
      );
    } else {
      this.addFinding('medium', 'authentication',
        'Gest√£o de Sess√µes Limitada',
        'Sess√µes podem n√£o ter controle adequado de expira√ß√£o',
        'Implementar controle robusto de sess√µes com TTL'
      );
    }
  }

  auditDataProtection() {
    console.log('üõ°Ô∏è Auditando Prote√ß√£o de Dados...');

    // Verificar valida√ß√£o de entrada
    const routesFile = fs.readFileSync('../server/routes.ts', 'utf8');
    
    if (routesFile.includes('safeParse') && routesFile.includes('zod')) {
      this.addFinding('low', 'dataProtection',
        'Valida√ß√£o de Entrada',
        'Sistema utiliza Zod para valida√ß√£o de dados',
        'Expandir valida√ß√£o para todos os endpoints',
        'pass'
      );
    } else {
      this.addFinding('high', 'dataProtection',
        'Valida√ß√£o de Entrada Insuficiente',
        'Dados de entrada n√£o s√£o adequadamente validados',
        'Implementar valida√ß√£o Zod em todos os endpoints'
      );
    }

    // Verificar sanitiza√ß√£o SQL
    const storageFile = fs.readFileSync('../server/storage-clients-auth.ts', 'utf8');
    
    if (storageFile.includes('supabase') && !storageFile.includes('${') && !storageFile.includes('concat')) {
      this.addFinding('low', 'dataProtection',
        'Prote√ß√£o contra SQL Injection',
        'Sistema utiliza ORM/Query Builder que previne SQL injection',
        'Manter uso do Supabase client e evitar queries raw',
        'pass'
      );
    } else {
      this.addFinding('high', 'dataProtection',
        'Risco de SQL Injection',
        'Poss√≠vel concatena√ß√£o de strings em queries SQL',
        'Utilizar apenas queries parametrizadas'
      );
    }

    // Verificar logs de dados sens√≠veis
    if (storageFile.includes('console.log') && (storageFile.includes('password') || storageFile.includes('token'))) {
      this.addFinding('medium', 'dataProtection',
        'Logs de Dados Sens√≠veis',
        'Logs podem conter informa√ß√µes sens√≠veis',
        'Remover ou mascarar dados sens√≠veis dos logs'
      );
    } else {
      this.addFinding('low', 'dataProtection',
        'Logs Seguros',
        'Logs n√£o exp√µem dados sens√≠veis',
        'Manter boas pr√°ticas de logging',
        'pass'
      );
    }
  }

  auditApiSecurity() {
    console.log('üåê Auditando Seguran√ßa da API...');

    const routesFile = fs.readFileSync('server/routes.ts', 'utf8');

    // Verificar rate limiting
    if (!routesFile.includes('rateLimit') && !routesFile.includes('express-rate-limit')) {
      this.addFinding('medium', 'apiSecurity',
        'Rate Limiting Ausente',
        'API n√£o possui prote√ß√£o contra ataques de for√ßa bruta',
        'Implementar rate limiting para endpoints sens√≠veis'
      );
    }

    // Verificar CORS
    if (!routesFile.includes('cors')) {
      this.addFinding('medium', 'apiSecurity',
        'CORS N√£o Configurado',
        'Pol√≠tica CORS n√£o est√° explicitamente configurada',
        'Configurar CORS adequadamente para produ√ß√£o'
      );
    }

    // Verificar helmet.js
    if (!routesFile.includes('helmet')) {
      this.addFinding('medium', 'apiSecurity',
        'Headers de Seguran√ßa Ausentes',
        'Headers de seguran√ßa n√£o est√£o configurados',
        'Implementar helmet.js para headers de seguran√ßa'
      );
    }

    // Verificar tratamento de erros
    if (routesFile.includes('try') && routesFile.includes('catch')) {
      this.addFinding('low', 'apiSecurity',
        'Tratamento de Erros',
        'API possui tratamento adequado de erros',
        'Evitar exposi√ß√£o de stack traces em produ√ß√£o',
        'pass'
      );
    } else {
      this.addFinding('high', 'apiSecurity',
        'Tratamento de Erros Inadequado',
        'Erros podem vazar informa√ß√µes sens√≠veis',
        'Implementar tratamento robusto de erros'
      );
    }
  }

  auditInfrastructure() {
    console.log('üèóÔ∏è Auditando Infraestrutura...');

    // Verificar vari√°veis de ambiente
    const envVars = [
      'DATABASE_URL',
      'SUPABASE_URL', 
      'SUPABASE_KEY'
    ];

    let envSecure = true;
    envVars.forEach(envVar => {
      if (!process.env[envVar]) {
        envSecure = false;
      }
    });

    if (envSecure) {
      this.addFinding('low', 'infrastructure',
        'Vari√°veis de Ambiente',
        'Credenciais est√£o em vari√°veis de ambiente',
        'Verificar se vari√°veis est√£o seguras em produ√ß√£o',
        'pass'
      );
    } else {
      this.addFinding('high', 'infrastructure',
        'Credenciais Expostas',
        'Algumas credenciais podem estar hardcoded',
        'Mover todas as credenciais para vari√°veis de ambiente'
      );
    }

    // Verificar depend√™ncias de seguran√ßa
    const packageJson = JSON.parse(fs.readFileSync('package.json', 'utf8'));
    const securityDeps = ['bcryptjs', 'cookie-parser'];
    
    let hasSecurityDeps = true;
    securityDeps.forEach(dep => {
      if (!packageJson.dependencies[dep] && !packageJson.devDependencies?.[dep]) {
        hasSecurityDeps = false;
      }
    });

    if (hasSecurityDeps) {
      this.addFinding('low', 'infrastructure',
        'Depend√™ncias de Seguran√ßa',
        'Bibliotecas de seguran√ßa est√£o instaladas',
        'Manter depend√™ncias atualizadas',
        'pass'
      );
    }
  }

  auditCodeQuality() {
    console.log('üíª Auditando Qualidade do C√≥digo...');

    // Verificar TypeScript
    if (fs.existsSync('tsconfig.json')) {
      this.addFinding('low', 'codeQuality',
        'TypeScript Configurado',
        'Projeto utiliza TypeScript para type safety',
        'Manter configura√ß√µes strict do TypeScript',
        'pass'
      );
    }

    // Verificar estrutura de arquivos
    const hasProperStructure = fs.existsSync('client') && 
                              fs.existsSync('server') && 
                              fs.existsSync('shared');

    if (hasProperStructure) {
      this.addFinding('low', 'codeQuality',
        'Estrutura Organizada',
        'Projeto possui estrutura bem organizada',
        'Manter separa√ß√£o clara entre frontend e backend',
        'pass'
      );
    }
  }

  auditPrivacy() {
    console.log('üîí Auditando Privacidade e LGPD...');

    const schemaFile = fs.readFileSync('shared/schema.ts', 'utf8');

    // Verificar campos de dados pessoais
    if (schemaFile.includes('email') && schemaFile.includes('phone')) {
      this.addFinding('medium', 'privacy',
        'Dados Pessoais Identificados',
        'Sistema coleta dados pessoais (email, telefone)',
        'Implementar pol√≠tica de privacidade e consentimento LGPD'
      );
    }

    // Verificar soft delete
    if (!schemaFile.includes('deletedAt') && !schemaFile.includes('isActive')) {
      this.addFinding('medium', 'privacy',
        'Exclus√£o de Dados',
        'Sistema pode n√£o implementar soft delete',
        'Implementar soft delete para compliance com LGPD'
      );
    }

    // Verificar auditoria
    if (schemaFile.includes('createdAt') && schemaFile.includes('updatedAt')) {
      this.addFinding('low', 'privacy',
        'Auditoria de Dados',
        'Sistema possui timestamps de auditoria',
        'Expandir logs de auditoria para opera√ß√µes sens√≠veis',
        'pass'
      );
    }
  }

  generateScore() {
    const weights = {
      critical: -10,
      high: -5,
      medium: -2,
      low: -1,
      passed: 1
    };

    let score = 0;
    Object.keys(this.findings).forEach(severity => {
      score += this.findings[severity].length * weights[severity];
    });

    const maxScore = this.findings.passed.length;
    const percentage = Math.max(0, Math.min(100, ((score + maxScore) / (maxScore * 2)) * 100));

    return {
      rawScore: score,
      percentage: Math.round(percentage),
      level: this.getSecurityLevel(percentage)
    };
  }

  getSecurityLevel(percentage) {
    if (percentage >= 90) return 'EXCELENTE';
    if (percentage >= 80) return 'BOM';
    if (percentage >= 70) return 'ADEQUADO';
    if (percentage >= 60) return 'REGULAR';
    return 'CR√çTICO';
  }

  generateReport() {
    console.log('\nüîç Gerando relat√≥rio de seguran√ßa...');

    const score = this.generateScore();
    
    const report = {
      metadata: {
        projectName: 'SempreCheioApp',
        auditDate: new Date().toISOString(),
        version: '2.0',
        auditor: 'Security Audit Script'
      },
      
      summary: {
        score: score.percentage,
        level: score.level,
        totalFindings: Object.values(this.findings).flat().length,
        criticalIssues: this.findings.critical.length,
        highIssues: this.findings.high.length,
        mediumIssues: this.findings.medium.length,
        lowIssues: this.findings.low.length,
        passedChecks: this.findings.passed.length
      },

      readinessForSale: {
        recommended: score.percentage >= 80,
        blockers: this.findings.critical.length === 0 && this.findings.high.length <= 2,
        priority_fixes: [
          ...this.findings.critical,
          ...this.findings.high.slice(0, 3)
        ]
      },

      findings: this.findings,

      recommendations: this.generateRecommendations(),

      compliance: {
        lgpd: score.percentage >= 70,
        commercialUse: score.percentage >= 80,
        enterpriseReady: score.percentage >= 90
      }
    };

    fs.writeFileSync(AUDIT_REPORT, JSON.stringify(report, null, 2));
    
    return report;
  }

  generateRecommendations() {
    const recommendations = [];

    if (this.findings.critical.length > 0) {
      recommendations.push({
        priority: 'CR√çTICA',
        action: 'Corrigir todas as vulnerabilidades cr√≠ticas antes da venda',
        impact: 'Risco de seguran√ßa grave que pode comprometer todo o sistema'
      });
    }

    if (this.findings.high.length > 2) {
      recommendations.push({
        priority: 'ALTA',
        action: 'Resolver issues de alta prioridade',
        impact: 'Vulnerabilidades que podem ser exploradas por atacantes'
      });
    }

    recommendations.push({
      priority: 'M√âDIA',
      action: 'Implementar rate limiting e headers de seguran√ßa',
      impact: 'Melhorar a postura de seguran√ßa geral da aplica√ß√£o'
    });

    recommendations.push({
      priority: 'BAIXA',
      action: 'Documentar pol√≠ticas de privacidade e seguran√ßa',
      impact: 'Compliance legal e transpar√™ncia para clientes'
    });

    return recommendations;
  }

  async runAudit() {
    console.log('üîí Iniciando Auditoria de Seguran√ßa - SempreCheioApp\n');

    this.auditAuthentication();
    this.auditDataProtection();
    this.auditApiSecurity();
    this.auditInfrastructure();
    this.auditCodeQuality();
    this.auditPrivacy();

    const report = this.generateReport();
    
    console.log('\nüìä RESUMO DA AUDITORIA');
    console.log('====================');
    console.log(`Score de Seguran√ßa: ${report.summary.score}% (${report.summary.level})`);
    console.log(`Issues Cr√≠ticas: ${report.summary.criticalIssues}`);
    console.log(`Issues Altas: ${report.summary.highIssues}`);
    console.log(`Issues M√©dias: ${report.summary.mediumIssues}`);
    console.log(`Verifica√ß√µes Aprovadas: ${report.summary.passedChecks}`);
    
    console.log('\nüéØ PRONTO PARA VENDA?');
    console.log('====================');
    console.log(`Recomendado: ${report.readinessForSale.recommended ? 'SIM' : 'N√ÉO'}`);
    console.log(`Sem Bloqueadores: ${report.readinessForSale.blockers ? 'SIM' : 'N√ÉO'}`);
    console.log(`LGPD Compliance: ${report.compliance.lgpd ? 'SIM' : 'N√ÉO'}`);
    console.log(`Uso Comercial: ${report.compliance.commercialUse ? 'SIM' : 'N√ÉO'}`);
    
    console.log(`\nüìã Relat√≥rio completo salvo em: ${AUDIT_REPORT}`);
    
    return report;
  }
}

const auditor = new SecurityAuditor();
auditor.runAudit().catch(console.error);